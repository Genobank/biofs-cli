# BioFS v1.2.0 Development TODO

**Version**: 1.1.0 → 1.2.0
**Goal**: Core BioNFT-Gated S3 CLI
**Timeline**: 2 weeks (Sprint 1 + Sprint 2)
**Priority**: P0 - Critical for MVP

---

## Sprint 1: Access Control Foundation (Week 1)

### 1.1 Command Structure Refactor
- [ ] Create category-based command system
  - [ ] `src/commands/access/` directory
  - [ ] `src/commands/s3/` directory
  - [ ] `src/commands/license/` directory
  - [ ] `src/commands/collection/` directory
  - [ ] `src/commands/bioip/` directory (move tokenize here)
  - [ ] `src/commands/auth/` directory (move login/logout here)
  - [ ] Update `src/index.ts` to use subcommands

### 1.2 Access Request (`biofs access request`)
- [ ] Create `src/commands/access/request.ts`
- [ ] API client method: `requestBiosampleAccess(ipId: string, message?: string)`
  - [ ] Endpoint: `POST /request_biosample`
  - [ ] Parameters: `user_signature`, `biosample_serial`, `message`
- [ ] CLI command:
  ```bash
  biofs access request <biocid|ip_id> [--message "Research purpose"]
  ```
- [ ] Features:
  - [ ] Resolve BioCID to IP Asset ID
  - [ ] Submit access request to owner
  - [ ] Show confirmation with request ID
  - [ ] Handle already-requested error gracefully
- [ ] Unit tests

### 1.3 Access Grant (`biofs access grant`)
- [ ] Create `src/commands/access/grant.ts`
- [ ] API client method: `approveBiosampleRequest(requestId: string, walletAddress: string)`
  - [ ] Endpoint: `POST /approve_biosample_request`
  - [ ] Parameters: `user_signature`, `request_id`, `permittee_address`
- [ ] CLI command:
  ```bash
  biofs access grant <biocid|ip_id> <wallet_address>
  ```
- [ ] Features:
  - [ ] Verify caller is NFT owner
  - [ ] Approve pending request
  - [ ] Show success confirmation
  - [ ] Option to grant with expiry: `--expires-in 30d`
- [ ] Unit tests

### 1.4 Access Revoke (`biofs access revoke`)
- [ ] Create `src/commands/access/revoke.ts`
- [ ] API client method: `revokeBiosampleAccess(ipId: string, walletAddress: string)`
  - [ ] Endpoint: `POST /revoke_biosample_request`
  - [ ] Parameters: `user_signature`, `biosample_serial`, `permittee_address`
- [ ] CLI command:
  ```bash
  biofs access revoke <biocid|ip_id> <wallet_address>
  ```
- [ ] Features:
  - [ ] Verify caller is NFT owner
  - [ ] Revoke access immediately
  - [ ] Confirmation prompt (unless `--yes`)
  - [ ] Show success message
- [ ] Unit tests

### 1.5 Access List (`biofs access list`)
- [ ] Create `src/commands/access/list.ts`
- [ ] API client methods:
  - [ ] `getPermittees(ipId: string)` → Endpoint: `GET /permittees?serial={serial}`
  - [ ] `getMyPermissions()` → Endpoint: `GET /get_permitted_biosamples?signature={sig}`
- [ ] CLI commands:
  ```bash
  # List permittees for my BioIP
  biofs access list <biocid|ip_id>

  # List BioIPs I have permission to access
  biofs access list --mine
  ```
- [ ] Features:
  - [ ] Table display with wallet, granted date, status
  - [ ] Filter by status: `--status active|pending|revoked`
  - [ ] JSON output: `--json`
- [ ] Unit tests

### 1.6 Access Check (`biofs access check`)
- [ ] Create `src/commands/access/check.ts`
- [ ] API client method: `checkMyAccess(ipId: string)`
  - [ ] Calls `getPermittees()` and checks if wallet is in list
  - [ ] Also checks NFT ownership via Story Protocol
- [ ] CLI command:
  ```bash
  biofs access check <biocid|ip_id>
  ```
- [ ] Features:
  - [ ] Shows access level: Owner, Permittee, or None
  - [ ] Shows license terms
  - [ ] Shows expiry date (if applicable)
  - [ ] Color-coded output (green=owner, yellow=permittee, red=none)
- [ ] Unit tests

### 1.7 NFT Ownership Verification Module
- [ ] Create `src/lib/blockchain/ownership.ts`
- [ ] Functions:
  - [ ] `getIPAssetOwner(ipId: string): Promise<string>`
    - [ ] Query Story Protocol explorer API
    - [ ] Cache results (5 min TTL)
  - [ ] `verifyOwnership(ipId: string, wallet: string): Promise<boolean>`
  - [ ] `isPermittee(ipId: string, wallet: string): Promise<boolean>`
    - [ ] Check GenoBank API permittee list
  - [ ] `hasAccess(ipId: string, wallet: string): Promise<{owner: boolean, permittee: boolean, access: boolean}>`
- [ ] Integration tests with testnet

### 1.8 BioCID Resolver Enhancement
- [ ] Update `src/lib/biofiles/biocid.ts`
- [ ] Add method: `resolveToIPAsset(biocid: string): Promise<{ipId: string, owner: string, s3_path: string}>`
- [ ] Add caching layer for resolution (10 min TTL)
- [ ] Unit tests

---

## Sprint 2: S3 Operations Parity (Week 2)

### 2.1 Enhanced List (`biofs s3 ls`)
- [ ] Refactor `src/commands/files.ts` → `src/commands/s3/ls.ts`
- [ ] Add S3-style path listing:
  ```bash
  # List all BioIPs
  biofs s3 ls

  # List specific BioCID
  biofs s3 ls biocid://0x5f5a.../bioip/3931d9ff...

  # List with details
  biofs s3 ls --long

  # Recursive listing
  biofs s3 ls --recursive
  ```
- [ ] Access control integration:
  - [ ] Only show files user owns or has permission to
  - [ ] Show access level in output (Owner/Permittee)
- [ ] Unit tests

### 2.2 Copy Command (`biofs s3 cp`)
- [ ] Create `src/commands/s3/cp.ts`
- [ ] Merge functionality from `upload` and `download`
- [ ] CLI command:
  ```bash
  # Upload
  biofs s3 cp local.vcf biocid://...

  # Download
  biofs s3 cp biocid://... local.vcf

  # Copy between BioIPs (future: requires dual ownership)
  biofs s3 cp biocid://source biocid://dest
  ```
- [ ] Access verification:
  - [ ] Check ownership/permittee before download
  - [ ] Verify destination ownership before upload
- [ ] Features:
  - [ ] Progress bar for large files
  - [ ] Resume support with `--resume`
  - [ ] Overwrite protection (prompt unless `--force`)
- [ ] Unit tests

### 2.3 Move Command (`biofs s3 mv`)
- [ ] Create `src/commands/s3/mv.ts`
- [ ] API client method: `moveFile(sourcePath: string, destPath: string)`
  - [ ] Requires ownership of source
  - [ ] Updates MongoDB records
  - [ ] Updates S3 object keys
- [ ] CLI command:
  ```bash
  biofs s3 mv biocid://old biocid://new
  ```
- [ ] Access verification:
  - [ ] Must be owner (no permittee access)
  - [ ] Confirmation prompt (unless `--yes`)
- [ ] Unit tests

### 2.4 Delete Command (`biofs s3 rm`)
- [ ] Create `src/commands/s3/rm.ts`
- [ ] API client method: `deleteFile(biocid: string)`
  - [ ] Endpoint: `POST /delete_user_file_from_bucket`
  - [ ] Requires ownership verification
- [ ] CLI command:
  ```bash
  biofs s3 rm biocid://...

  # Recursive delete (future)
  biofs s3 rm biocid://... --recursive
  ```
- [ ] Safety features:
  - [ ] **CRITICAL**: Require `--confirm-delete` flag
  - [ ] Show what will be deleted
  - [ ] Type filename to confirm for important files
  - [ ] No delete for files with active permittees (unless `--force`)
- [ ] Unit tests

### 2.5 Sync Command (`biofs s3 sync`)
- [ ] Create `src/commands/s3/sync.ts`
- [ ] CLI command:
  ```bash
  # Sync local directory to BioNFT
  biofs s3 sync ./local-vcfs/ biocid://...

  # Sync down
  biofs s3 sync biocid://... ./local-vcfs/

  # Dry run
  biofs s3 sync ./local/ biocid://... --dry-run
  ```
- [ ] Features:
  - [ ] Compare checksums (SNP fingerprints for genomic files)
  - [ ] Skip unchanged files
  - [ ] Option to delete removed files: `--delete`
  - [ ] Progress indicator
- [ ] Access verification on every file
- [ ] Unit tests

### 2.6 Presign Command (`biofs s3 presign`)
- [ ] Create `src/commands/s3/presign.ts`
- [ ] API client method: `generatePresignedURL(biocid: string, expiresIn: number)`
  - [ ] Endpoint: `POST /get_presigned_link`
  - [ ] Requires access verification first
- [ ] CLI command:
  ```bash
  biofs s3 presign biocid://... [--expires-in 3600]
  ```
- [ ] Features:
  - [ ] Default 1 hour expiry
  - [ ] Max 7 days expiry
  - [ ] Copy to clipboard option: `--copy`
  - [ ] QR code generation: `--qr`
- [ ] Access verification:
  - [ ] Owner or permittee can presign
  - [ ] Respect license terms (commercial/non-commercial)
- [ ] Unit tests

### 2.7 Stat Command (`biofs s3 stat`)
- [ ] Create `src/commands/s3/stat.ts`
- [ ] API client method: `getFileMetadata(biocid: string)`
- [ ] CLI command:
  ```bash
  biofs s3 stat biocid://...
  ```
- [ ] Display:
  - [ ] Filename, size, type
  - [ ] Owner wallet
  - [ ] IP Asset ID
  - [ ] License type
  - [ ] Created/modified dates
  - [ ] Permittee count
  - [ ] SNP fingerprint (for genomic files)
  - [ ] S3 path
  - [ ] IPFS hash (if available)
- [ ] Access verification required
- [ ] Unit tests

---

## Sprint 3: Hybrid Authentication (Week 2 - Parallel)

### 3.1 AWS Credentials Management
- [ ] Create `src/lib/auth/aws.ts`
- [ ] Functions:
  - [ ] `setAWSCredentials(accessKeyId: string, secretAccessKey: string, region?: string)`
  - [ ] `getAWSCredentials(): Promise<{accessKeyId: string, secretAccessKey: string, region: string}>`
  - [ ] `clearAWSCredentials()`
  - [ ] `validateAWSCredentials(): Promise<boolean>`
- [ ] Storage location: `~/.biofs/aws_credentials` (encrypted)
- [ ] Encryption key derived from Web3 signature

### 3.2 Config Command (`biofs config`)
- [ ] Create `src/commands/config/` directory
- [ ] Subcommands:
  - [ ] `biofs config show` - Show all configuration
  - [ ] `biofs config set <key> <value>` - Set config value
  - [ ] `biofs config get <key>` - Get config value
  - [ ] `biofs config export [--format boto|json]` - Export for boto-biofs
  - [ ] `biofs config aws set-credentials` - Interactive AWS setup
  - [ ] `biofs config aws get-credentials` - Show AWS creds (masked)
- [ ] Config file: `~/.biofs/config.json`
- [ ] Unit tests

### 3.3 Dual Authentication Module
- [ ] Create `src/lib/auth/hybrid.ts`
- [ ] Functions:
  - [ ] `verifyDualAuth(): Promise<{web3Valid: boolean, awsValid: boolean}>`
  - [ ] `enforceAccess(biocid: string): Promise<void>` - Throws if no access
- [ ] Flow:
  1. Verify Web3 signature
  2. Verify AWS credentials (optional for read-only)
  3. Check NFT ownership/permittee
  4. Check license compliance
  5. Return presigned URL or error
- [ ] Integration tests

### 3.4 boto-biofs Config Export
- [ ] Create `src/commands/config/export.ts`
- [ ] Output format for `--format boto`:
  ```json
  {
    "wallet_address": "0x5f5a60EaEf242c0D51A21c703f520347b96Ed19a",
    "signature": "0xa5141ae955bba91ad46a940aefc3b05120489b8b...",
    "api_endpoint": "https://genobank.app",
    "aws_access_key_id": "AKIAIOSFODNN7EXAMPLE",
    "aws_secret_access_key": "***MASKED***",
    "default_region": "us-east-1",
    "nft_verification_enabled": true,
    "cache_ttl_seconds": 300
  }
  ```
- [ ] Write to: `~/.biofs/boto_config.json`
- [ ] Document integration in README

---

## Testing Strategy

### Unit Tests (Target: 80% coverage)
- [ ] All command functions
- [ ] BioCID resolver
- [ ] Access verification logic
- [ ] AWS credentials encryption
- [ ] NFT ownership checking

### Integration Tests
- [ ] End-to-end access request → grant → download flow
- [ ] Dual auth verification with testnet
- [ ] S3 operations with access control
- [ ] License compliance checking

### Manual Testing Checklist
- [ ] Upload VCF with BioNFT gating
- [ ] Request access as different wallet
- [ ] Grant access and verify download works
- [ ] Revoke access and verify download fails
- [ ] Presign URL and verify expiry
- [ ] Export boto config and test with Python

---

## Documentation

### User Documentation
- [ ] README.md updates with new commands
- [ ] QUICKSTART.md for access control workflow
- [ ] API.md documenting all commands
- [ ] BOTO_INTEGRATION.md for Python users

### Developer Documentation
- [ ] ARCHITECTURE.md explaining access control flow
- [ ] CONTRIBUTING.md with development setup
- [ ] TESTING.md with test guidelines

---

## Success Criteria for v1.2.0

### Must Pass
- [ ] All unit tests passing (≥80% coverage)
- [ ] Integration tests passing
- [ ] Can request/grant/revoke access via CLI
- [ ] NFT ownership verification working
- [ ] All S3 operations (ls, cp, mv, rm, sync, presign) working
- [ ] Dual auth (Web3 + AWS) working
- [ ] Access denied if not owner/permittee
- [ ] boto-biofs config export working

### Performance Targets
- [ ] Access check: <200ms
- [ ] File list: <500ms for 100 files
- [ ] Download: Same speed as direct S3
- [ ] Upload: <10% overhead vs direct S3

### Security Checklist
- [ ] Signature verification on every operation
- [ ] NFT ownership checked before access
- [ ] AWS credentials encrypted at rest
- [ ] No secrets in logs
- [ ] Presigned URLs expire correctly
- [ ] Access revocation takes effect immediately

---

## Breaking Changes from v1.1.0

### Command Structure Changes
```bash
# OLD (v1.1.0)
biofs files
biofs download <file>
biofs upload <file>
biofs tokenize <file>

# NEW (v1.2.0) - Backwards compatible aliases
biofs s3 ls          # alias: biofs files
biofs s3 cp <src> <dst>  # replaces download/upload
biofs bioip register <file>  # alias: biofs tokenize

# NEW ONLY (v1.2.0)
biofs access request <biocid>
biofs access grant <biocid> <wallet>
biofs config aws set-credentials
```

**Migration Strategy**: Keep old commands as aliases for 2 versions (deprecate in v1.4.0)

---

## Release Checklist

### Pre-Release
- [ ] All TODO items completed
- [ ] Tests passing
- [ ] Documentation updated
- [ ] CHANGELOG.md updated
- [ ] Version bumped to 1.2.0

### Release
- [ ] Create git tag: `v1.2.0`
- [ ] Build: `npm run build`
- [ ] Test install: `npm link`
- [ ] Publish to npm: `npm publish`
- [ ] GitHub release with notes

### Post-Release
- [ ] Announce in Discord/Slack
- [ ] Update demo videos
- [ ] Monitor error logs
- [ ] Gather user feedback

---

**Last Updated**: October 5, 2025
**Status**: Ready for Development
**Estimated Effort**: 80 hours (2 developers × 2 weeks)
