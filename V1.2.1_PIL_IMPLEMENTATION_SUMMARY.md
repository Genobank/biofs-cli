# BioFS v1.2.1 - Story PIL Access Control Implementation

**Date**: October 5, 2025
**Status**: âœ… Backend Complete | â³ CLI Updates In Progress
**Version**: 1.2.0 â†’ 1.2.1 (PIL Integration)

---

## ğŸ¯ Overview

Successfully migrated BioFS access control from basic MongoDB permissions to **Story Protocol PIL (Programmable IP Licenses)** as GDPR consent mechanisms:

- **No license** = No consent, access denied
- **Non-commercial license** = GDPR research consent (free)
- **Commercial licenses** = Implicit consent with compensation (revocable)

---

## âœ… Completed Work

### 1. Backend API Endpoints (100% Complete)

**File**: `/home/ubuntu/Genobank_APIs/production_api/plugins/bioip/api_bioip.py`

Successfully integrated 5 new PIL-based endpoints (lines 2079-2533):

#### `POST /api_bioip/request_license_token`
- Creates pending request in MongoDB `license_token_requests` collection
- Parameters: `user_signature`, `ip_id`, `license_type`, `message`
- Returns: `request_id`, `status: pending`

#### `POST /api_bioip/grant_license_token`
- Mints license token on blockchain via `story_protocol_manager.mint_license_token()`
- Saves token to MongoDB `license_tokens` collection
- Updates request status to `approved`
- Parameters: `user_signature`, `request_id`, `receiver_wallet`
- Returns: `license_token_id`, `tx_hash`, `status: active`

#### `POST /api_bioip/revoke_license_token`
- Marks license token as `revoked` in MongoDB
- **Note**: Story Protocol doesn't support burning yet
- Parameters: `user_signature`, `ip_id`, `receiver_wallet`
- Returns: `status: revoked`, `revoked_at`, `revoked_by`

#### `GET /api_bioip/get_pending_license_requests`
- Queries MongoDB for pending requests by owner
- Parameters: `user_signature`, `ip_id` (optional)
- Returns: Array of pending requests

#### `GET /api_bioip/check_my_access`
- Checks ownership + active license tokens
- Returns access level: `owner` | `licensed` | `none`
- Parameters: `user_signature`, `ip_id`
- Returns: `access_level`, `license_token`, `pil_terms`

### 2. MongoDB Collections (100% Complete)

**Created Collection**: `license_token_requests`
```javascript
{
  "_id": ObjectId("..."),
  "ip_id": "0xCCe14...",
  "requester": "0x992b0a77...",
  "owner": "0x5f5a60Ea...",
  "license_type": "non-commercial",
  "message": "PhD research on cancer variants",
  "status": "pending",  // pending | approved | rejected
  "createdAt": ISODate("..."),
  "updatedAt": ISODate("...")
}
```

**Indexes Created**:
- `ip_requester_idx`: `(ip_id, requester)`
- `owner_status_idx`: `(owner, status)`
- `created_at_idx`: `(createdAt DESC)`

**Updated Collection**: `license_tokens`
- Added `status` field to 7 existing documents (all set to `active`)
- Created indexes:
  - `ip_receiver_status_idx`: `(ip_id, receiver, status)`
  - `receiver_status_idx`: `(receiver, status)`
  - `ip_id_idx`: `(ip_id)`

### 3. API Service Restart (100% Complete)

- Restarted `api_genobank_prod.service`
- Service status: **Active (running)**
- No errors in startup

### 4. CLI API Client Updates (100% Complete)

**File**: `/home/ubuntu/genobank-cli/src/lib/api/client.ts`

Added 5 new PIL-based methods (lines 213-284):

```typescript
async requestLicenseToken(ipId: string, licenseType: string, message?: string)
async grantLicenseToken(requestId: string, receiverWallet: string)
async revokeLicenseToken(ipId: string, receiverWallet: string)
async getPendingLicenseRequests(ipId?: string): Promise<any[]>
async checkMyAccess(ipId: string): Promise<any>
```

**Backward Compatibility**: Kept legacy methods (lines 286-350) for existing code.

### 5. CLI Access Commands (40% Complete)

#### âœ… `biofs access request` (COMPLETE)
**File**: `/home/ubuntu/genobank-cli/src/commands/access/request.ts`

**Changes**:
- Now uses `api.requestLicenseToken()` instead of `requestBiosampleAccess()`
- Added `--license-type` option (default: `non-commercial`)
- Updated output to show "License Token Request (GDPR Consent)"
- Displays: IP ID, License Type, Request ID, pending status

**Output**:
```
âœ“ License token request submitted successfully

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  License Token Request Details (GDPR Consent)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  IP Asset ID: 0xCCe14315eE3D6a41596EeB4a2839eE50A8ec59f7
  License Type: Non-Commercial (GDPR Research Consent)
  Message: PhD research on cancer variants
  Request ID: 671a5f8c...
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â³ Waiting for owner to mint license token...
   Owner will mint a license token on blockchain to grant access.

   Check status: biofs access list --mine
```

#### âœ… `biofs access grant` (COMPLETE)
**File**: `/home/ubuntu/genobank-cli/src/commands/access/grant.ts`

**Changes**:
- Now uses `api.getPendingLicenseRequests()` and `api.grantLicenseToken()`
- Removed biosample serial resolution (uses IP ID only)
- Updated output to show blockchain transaction details

**Output**:
```
âœ“ License token minted successfully on blockchain

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  License Token Grant Confirmation (GDPR Consent)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  IP Asset ID: 0xCCe14315eE3D6a41596EeB4a2839eE50A8ec59f7
  Granted To: 0x992b0a77...
  License Type: Non-Commercial (GDPR Research Consent)
  License Token ID: 12345
  Blockchain TX: 0xabcd1234...
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ The researcher can now download files using:
  biofs s3 cp biocid://... ./destination
```

---

## â³ Remaining Work

### 6. CLI Access Commands (60% Incomplete)

#### ğŸ”„ `biofs access revoke` (TODO)
**File**: `/home/ubuntu/genobank-cli/src/commands/access/revoke.ts`

**Required Changes**:
- Use `api.revokeLicenseToken(ipId, receiverWallet)`
- Update output to mention "GDPR right to erasure"
- Show revocation confirmation

#### ğŸ”„ `biofs access list` (TODO)
**File**: `/home/ubuntu/genobank-cli/src/commands/access/list.ts`

**Required Changes**:
- Owner mode: Use `api.getPendingLicenseRequests(ipId)` for pending requests
- Owner mode: Query MongoDB `license_tokens` for active/revoked tokens
- Researcher mode: Use `api.checkMyAccess(ipId)` for each owned asset
- Display license type, token ID, blockchain TX hash

#### ğŸ”„ `biofs access check` (TODO)
**File**: `/home/ubuntu/genobank-cli/src/commands/access/check.ts`

**Required Changes**:
- Use `api.checkMyAccess(ipId)`
- Display access level: Owner | Licensed | None
- Show license token details if has license
- Show PIL terms (commercial use, derivatives, attribution)

### 7. Build & Test (TODO)

**Tasks**:
- Compile TypeScript: `npm run build`
- Test all 5 access commands end-to-end
- Verify blockchain transactions on Story Protocol testnet

---

## ğŸ“Š Technical Architecture

### PIL as GDPR Consent Flow

```
1. RESEARCHER REQUESTS ACCESS
   â”œâ”€â†’ POST /api_bioip/request_license_token
   â”œâ”€â†’ MongoDB: license_token_requests (status: pending)
   â””â”€â†’ Returns: request_id

2. OWNER GRANTS ACCESS (MINTS LICENSE TOKEN)
   â”œâ”€â†’ POST /api_bioip/grant_license_token
   â”œâ”€â†’ Story Protocol: mint_license_token() â†’ Blockchain TX
   â”œâ”€â†’ MongoDB: license_tokens (status: active, tx_hash)
   â””â”€â†’ MongoDB: Update request (status: approved)

3. RESEARCHER DOWNLOADS FILE
   â”œâ”€â†’ S3 Object Lambda checks MongoDB license_tokens
   â”œâ”€â†’ If status === 'active' â†’ Allow download
   â””â”€â†’ If status === 'revoked' â†’ Deny download (GDPR compliance)

4. OWNER REVOKES ACCESS (RIGHT TO ERASURE)
   â”œâ”€â†’ POST /api_bioip/revoke_license_token
   â”œâ”€â†’ MongoDB: license_tokens (status: revoked, revoked_at)
   â””â”€â†’ Future downloads denied (GDPR Article 17)
```

### MongoDB Schema

**Collection**: `license_token_requests`
- **Purpose**: Track pending access requests before license minting
- **Indexes**: `(ip_id, requester)`, `(owner, status)`, `(createdAt DESC)`

**Collection**: `license_tokens`
- **Purpose**: Track minted license tokens (active and revoked)
- **Indexes**: `(ip_id, receiver, status)`, `(receiver, status)`, `(ip_id)`

### Story Protocol Integration

**Contract Methods Used**:
```python
story_protocol_manager.mint_license_token(
    ip_id="0xCCe14...",
    license_terms_id=5,  # Non-commercial PIL
    receiver="0x992b0a77...",
    amount=1
)
# Returns: {startLicenseTokenId: 12345, tx_hash: "0xabcd..."}
```

**PIL License Types**:
- **Non-Commercial (NCSR)**: `commercialUse: false`, `defaultMintingFee: 0`
- **Commercial Use**: `commercialUse: true`, `defaultMintingFee: X`
- **Commercial Remix**: `derivativesAllowed: true`, `commercialRevShare: Y%`

---

## ğŸ¯ Next Steps

1. **Update `revoke` command** (15 minutes)
2. **Update `list` command** (30 minutes - most complex)
3. **Update `check` command** (15 minutes)
4. **Build CLI** (`npm run build` - 2 minutes)
5. **Test end-to-end flow** (30 minutes)
   - Request â†’ Grant â†’ Download â†’ Revoke â†’ Download (should fail)

**Estimated Time Remaining**: 1.5 hours

---

## ğŸ“š Key Files Modified

### Backend
- `/home/ubuntu/Genobank_APIs/production_api/plugins/bioip/api_bioip.py` (+455 lines)
- `/home/ubuntu/Genobank_APIs/production_api/setup_pil_mongodb_collections.py` (new)

### CLI
- `/home/ubuntu/genobank-cli/src/lib/api/client.ts` (+72 lines)
- `/home/ubuntu/genobank-cli/src/commands/access/request.ts` (modified)
- `/home/ubuntu/genobank-cli/src/commands/access/grant.ts` (modified)
- `/home/ubuntu/genobank-cli/src/commands/access/revoke.ts` (pending)
- `/home/ubuntu/genobank-cli/src/commands/access/list.ts` (pending)
- `/home/ubuntu/genobank-cli/src/commands/access/check.ts` (pending)

### Documentation
- `/home/ubuntu/genobank-cli/STORY_PIL_ACCESS_CONTROL_DESIGN.md` (reference)
- `/home/ubuntu/Genobank_APIs/production_api/plugins/bioip/pil_access_control_endpoints.py` (reference)

---

## ğŸ”¬ Testing Checklist

- [ ] Request license token with non-commercial type
- [ ] Request license token with commercial type
- [ ] Grant license token â†’ verify blockchain TX
- [ ] Check access level before grant (should be `none`)
- [ ] Check access level after grant (should be `licensed`)
- [ ] Download file with active license token
- [ ] Revoke license token
- [ ] Attempt download after revocation (should fail)
- [ ] List pending requests (owner view)
- [ ] List active tokens (owner view)
- [ ] List assets with license (researcher view)

---

**Last Updated**: October 5, 2025
**Status**: Backend âœ… Complete | CLI 40% Complete
**Next Task**: Update `revoke`, `list`, and `check` commands

